<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ìš©ì ëª©ë¡</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css">
</head>
<body class="bg-light">
<div class="container py-5">
    <h2 class="mb-4">ì‚¬ìš©ì ëª©ë¡</h2>
    <div class="mb-3 text-end">
        <button class="btn btn-primary" id="useradd">+ ì‚¬ìš©ì ì¶”ê°€</button>
    </div>
    <div class="table-responsive">
        <table id="userTable"
               class="table table-bordered table-hover align-middle"
               data-toggle="table"
               data-search="true"
               data-pagination="true"
               data-page-size="5">
            <thead class="table-light">
            <tr>
                <th data-field="role" data-sortable="true">ê¶Œí•œ</th>
                <th data-field="userId" data-sortable="true" data-formatter="userIdFormatter">ì•„ì´ë””</th>
                <th data-field="username" data-sortable="true">ì´ë¦„</th>
                <th data-field="email" data-sortable="true">ì´ë©”ì¼</th>
                <th data-field="isActive" data-sortable="true">ì‚¬ìš©ì—¬ë¶€</th>
                <th data-field="actions">ê´€ë¦¬</th> <!-- formatter ì œê±° -->
            </tr>
            </thead>
        </table>
    </div>
</div>

<script src="/js/common.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script>
<script src="https://unpkg.com/bootstrap-table@1.22.1/dist/themes/bootstrap-table-bs5/bootstrap-table-bs5.min.js"></script>

<script>
    async function loadUserTable() {
      const users = await ApiUtil.get("/api/admin/user-list");

      // ë²„íŠ¼ í¬í•¨ HTMLë¡œ actions í•„ë“œ êµ¬ì„±
      const usersWithAction = users.map(user => ({
        ...user,
        actions: `<button class="btn btn-danger btn-sm static-delete-btn" data-userid="${user.userId}">ì‚­ì œ</button>`
      }));

      $("#userTable").bootstrapTable('load', usersWithAction);

      setTimeout(() => {
        document.querySelectorAll(".static-delete-btn").forEach(button => {
          button.addEventListener("click", async function () {
            const userId = this.dataset.userid;
            console.log("ğŸ—‘ ì‚­ì œ ë²„íŠ¼ í´ë¦­ë¨:", userId);
            const confirmed = await AlertUtil.showConfirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
            if (!confirmed) return;
            await ApiUtil.del(`/api/admin/user-delete/${userId}`);
            loadUserTable();
          });
        });
      }, 0);
    }

    function userIdFormatter(value, row) {
      return `<a href="/admin/user_detail.html?userId=${encodeURIComponent(value)}" class="text-primary">${value}</a>`;
    }

    document.addEventListener("DOMContentLoaded", function () {
      $('#userTable').bootstrapTable();
      loadUserTable();
    });

    const formHtml = `
      <form id="addUserForm">
        <div class="form-group mb-3">
          <label for="userId" class="form-label">ì•„ì´ë””</label>
          <input type="text" class="form-control" id="userId" name="userId" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required />
        </div>
        <div class="form-group mb-3">
          <label for="username" class="form-label">ì´ë¦„</label>
          <input type="text" class="form-control" id="username" name="username" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required />
        </div>
        <div class="form-group mb-3">
          <label for="email" class="form-label">ì´ë©”ì¼</label>
          <input type="email" class="form-control" id="email" name="email" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”" required />
        </div>
      </form>
    `;

    document.getElementById('useradd').onclick = function () {
      console.log("ì‚¬ìš©ì ì¶”ê°€ ë²„íŠ¼ í´ë¦­ë¨");

      Modal.showFormModal({
        title: 'ì‚¬ìš©ì ì¶”ê°€',
        formContent: formHtml,
        onConfirm: async function () {
          console.log("ëª¨ë‹¬ í™•ì¸ ë²„íŠ¼ í´ë¦­ë¨");
          const form = document.getElementById('addUserForm');
          const data = {
            userId: form.userId.value,
            username: form.username.value,
            email: form.email.value
          };

          const result = await ApiUtil.post('/api/admin/user-add', data);
          if (result) {
            console.log("ì‚¬ìš©ì ì¶”ê°€ ì„±ê³µ");
            Modal.hideModal();
            loadUserTable(); // reload instead of location.reload()
          } else {
            console.log("ì‚¬ìš©ì ì¶”ê°€ ì‹¤íŒ¨");
          }
        }
      });
    };
</script>

<div id="globalModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1050;">
    <div class="modal-content shadow bg-white rounded p-4 mx-auto mt-5" style="max-width: 500px;">
        <div class="modal-header border-bottom-0">
            <span class="modal-title fw-bold fs-5"></span>
        </div>
        <div class="modal-body mt-2"></div>
        <div class="modal-footer border-top-0 d-flex justify-content-end mt-3">
            <button id="modalConfirmBtn" class="btn btn-primary">í™•ì¸</button>
            <button type="button" class="btn btn-secondary" onclick="Modal.hideModal()">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

</body>
</html>
