<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>게시글 상세</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
    <link href="/css/board_detail.css" rel="stylesheet" />
</head>
<body>
<div class="page-wrapper">
    <div class="post-card shadow">
        <h2 class="post-title" id="boardTitle">제목 로딩 중...</h2>
        <div class="post-meta">
            <span id="writer">작성자: ...</span>
            <span id="createDate">작성일: ...</span>
        </div>
        <div class="post-content content-box" id="boardContent">내용 로딩 중...</div>
        <div class="d-flex justify-content-between mt-4">
            <div class="d-flex gap-2">
                <button id="updateBtn" class="btn btn-update d-none">
                    <i class="fas fa-edit"></i> 수정하기
                </button>
                <button id="deleteBtn" class="btn btn-delete d-none">
                    <i class="fas fa-trash-alt"></i> 삭제하기
                </button>
            </div>
            <div>
                <button onclick="location.href='/board/board_list.html'" class="btn btn-list">
                    <i class="fas fa-list-ul"></i> 목록으로
                </button>
            </div>
        </div>
    </div>
</div>
</body>
<script src="/js/common.js"></script>
<script>
    const boardId = new URLSearchParams(window.location.search).get('id');
    const localUserId = localStorage.getItem('userId');
    let currentBoard = null;

    function showErrorAndRedirect(message) {
        AlertUtil.showError(message).then(() => {
            window.location.href = "/board/board_list.html";
        });
    }

    async function loadBoardDetail() {
        if (!boardId) {
            return showErrorAndRedirect("유효하지 않은 게시글 ID입니다.");
        }

        try {
            const board = await ApiUtil.get(`/v1/board/${boardId}`);
            if (!board) {
                return showErrorAndRedirect("게시글을 찾을 수 없습니다.");
            }

            currentBoard = board;

            document.getElementById("boardTitle").textContent = board.title;
            document.getElementById("writer").textContent = `작성자: ${board.username}`;
            document.getElementById("createDate").textContent = `작성일: ${new Date(board.createAt).toLocaleDateString('ko-KR', {
                year: 'numeric', month: 'long', day: 'numeric'
            })}`;
            document.getElementById("boardContent").textContent = board.content;

            if (String(board.userId) === String(localUserId)) {
                document.getElementById("updateBtn").classList.remove("d-none");
                document.getElementById("deleteBtn").classList.remove("d-none");
            }

        } catch (e) {
            console.error("API 호출 중 예외 발생:", e);
            showErrorAndRedirect("게시글을 불러오는 중 오류가 발생했습니다.");
        }
    }

    function handleUpdateClick() {
        if (!currentBoard) {
            AlertUtil.showError("게시글 정보가 아직 로드되지 않았습니다.");
            return;
        }

        if (String(currentBoard.userId) !== String(localUserId)) {
            AlertUtil.showWarning("수정에 대한 권한이 없습니다.");
            return;
        }

        window.location.href = `/board/board_update.html?id=${boardId}`;
    }

    async function handleDeleteClick() {
        const confirm = await AlertUtil.showConfirm("정말 삭제하시겠습니까?");
        if (!confirm) return;

        try {
            const result = await ApiUtil.del(`/v1/board/${boardId}`);
            if (result) {
                window.location.href = "/board/board_list.html";
            } else {
                AlertUtil.showError("삭제에 실패했습니다.");
            }
        } catch (e) {
            console.error("삭제 중 예외 발생:", e);
            AlertUtil.showError("삭제 중 오류가 발생했습니다.");
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        setTimeout(loadBoardDetail, 100);
        document.getElementById("updateBtn").addEventListener("click", handleUpdateClick);
        document.getElementById("deleteBtn").addEventListener("click", handleDeleteClick);
    });
</script>
</html>
