<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로그인</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+KR:400,700&display=swap" rel="stylesheet">
    <style>
        body {
            background: #f8fafb;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Noto Sans KR', '맑은 고딕', 'Malgun Gothic', Arial, sans-serif;
        }

        .login-card {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            max-width: 360px;
            width: 100%;
            margin: 0 auto 200px auto;
            border: 1px solid #e5e8eb;
        }

        .login-header {
            padding: 2rem 1.5rem 1rem 1.5rem;
            text-align: center;
            border-bottom: 1px solid #f0f2f4;
        }

        .login-header h2 {
            font-size: 1.6rem;
            font-weight: 700;
            color: #222;
            margin-bottom: 0.5rem;
        }

        .login-header p {
            color: #888;
            font-size: 1rem;
            margin-bottom: 0;
        }

        .login-body {
            padding: 1.5rem;
        }

        .form-group label {
            color: #333;
            font-weight: 500;
            font-size: 1rem;
            margin-bottom: 0.3rem;
        }

        .form-control {
            border-radius: 6px;
            border: 1.5px solid #e5e8eb;
            background: #fff;
            font-size: 1rem;
            padding: 10px 12px;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            border-color: #03c75a;
            box-shadow: none;
            background: #fff;
        }

        .btn-login {
            background: #03c75a;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 12px 0;
            font-size: 1.1rem;
            font-weight: 700;
            margin-top: 10px;
            transition: background 0.2s;
        }

        .btn-login:hover {
            background: #02b152;
        }

        .text-muted, .text-muted a {
            color: #aaa !important;
            font-size: 0.97rem;
        }

        .login-footer {
            text-align: center;
            margin-top: 1.2rem;
        }

        /* 모달을 화면 하단 중앙에 고정 */
        #globalModal {
            position: fixed;
            left: 50%;
            bottom: 0;
            transform: translateX(-50%) translateY(0);
            z-index: 1050;
            width: 100%;
            max-width: 400px;
            padding-bottom: 32px;
            display: none;
            background: none;
        }

        #globalModal .modal-content {
            border-radius: 10px;
            box-shadow: 0 -2px 16px rgba(0, 0, 0, 0.15);
            background: #fff;
            padding: 0;
        }

        #globalModal .modal-header, #globalModal .modal-footer {
            border: none;
            background: #fff;
        }

        #globalModal .modal-title {
            font-weight: 700;
            font-size: 1.2rem;
        }

        #globalModal .modal-body {
            padding: 1.2rem 1.5rem 0.5rem 1.5rem;
        }

        #globalModal .modal-footer {
            padding: 0.5rem 1.5rem 1.2rem 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        @media (max-width: 500px) {
            #globalModal {
                max-width: 98vw;
                padding-bottom: 0;
            }
        }
    </style>
</head>
<body>
<div class="login-card">
    <div class="login-header">
        <h2>로그인</h2>
        <p>계정에 로그인하세요</p>
    </div>
    <div class="login-body">
        <form id="loginForm">
            <div class="form-group">
                <label for="userId">아이디</label>
                <input type="text" class="form-control" id="userId" placeholder="아이디를 입력하세요"/>
            </div>
            <div class="form-group">
                <label for="password">비밀번호</label>
                <input type="password" class="form-control" id="password" placeholder="비밀번호를 입력하세요"/>
            </div>
            <button type="submit" class="btn btn-login btn-block" id="submit">로그인</button>
        </form>
        <div class="login-footer">
            <a href="/user/signup_jpa.html" class="text-muted">계정이 없으신가요?</a>
        </div>
    </div>
</div>

<div id="globalModal">
    <div class="modal-content shadow">
        <div class="modal-header">
            <span class="modal-title"></span>
        </div>
        <div class="modal-body"></div>
        <div class="modal-footer">
            <button id="modalConfirmBtn" class="btn btn-primary">확인</button>
            <button type="button" class="btn btn-secondary" onclick="Modal.hideModal()">취소</button>
        </div>
    </div>
</div>
</body>


<script src="/js/common.js"></script>
<script>
    document.getElementById('loginForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        const userId = StringUtil.trim(document.getElementById('userId').value)
        const password = StringUtil.trim(document.getElementById('password').value)
        const result = await ApiUtil.post("/api/user/login", {userId, password});

        if (result) {
            const {userId, role} = result;

            if (role === "TEMP") {
                showPasswordChangeModal(userId, password);
                return;
            }
            localStorage.setItem("userId", userId);
            const url = (role === "ADMIN") ? "/admin/user_list.html" : "/board/board_list.html";
            location.href = url;
        }
    })


    // 임시사용자 비밀번호 변경 모달 내용 html
    const formHtml = `
    <form id="updatePasswordForm">
      <div class="form-group mb-3">
        <label for="newPassword" class="form-label">비밀번호</label>
        <input
          type        = "password"
          class       = "form-control"
          id          = "newPassword"
          name        = "newPassword"
          placeholder = "비밀번호를 입력하세요"
          required />
      </div>
      <div class="form-group mb-3">
        <label for="newPasswordConfirm" class="form-label">비밀번호 확인</label>
        <input
          type        = "password"
          class       = "form-control"
          id          = "newPasswordConfirm"
          name        = "newPasswordConfirm"
          placeholder = "비밀번호 확인을 입력하세요"
          required />
      </div>
    </form>
  `;

    // 비밀번호 변경 모달 표시
    function showPasswordChangeModal(userId, oldPassword) {
        const $userId = document.getElementById("userId");
        const $password = document.getElementById("password");
        const $submit = document.getElementById("submit");

        $userId.disabled = true;
        $password.disabled = true;
        $submit.disabled = true;

        Modal.showFormModal({
            title: "임시 사용자 비밀번호 변경",
            formContent: formHtml,
            onConfirm: async () => {
                const form = document.querySelector('#updatePasswordForm');
                const newPassword = form.newPassword.value.trim();
                const newPasswordConfirm = form.newPasswordConfirm.value.trim();

                if (!isPasswordMatch(newPassword, newPasswordConfirm)) {
                    await AlertUtil.showError("비밀번호와 비밀번호 확인이 일치하지 않습니다");
                } else {
                    const data = {
                        userId: userId,
                        oldPassword: oldPassword,
                        newPassword: newPassword
                    };

                    const result = await ApiUtil.put("/api/user/user-password-update", data);
                    if (result) {
                        Modal.hideModal();
                        location.href = "login.html";
                    }
                }
            },
        })
    }
</script>
</html>