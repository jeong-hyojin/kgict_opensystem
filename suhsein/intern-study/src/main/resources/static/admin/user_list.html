<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <title>관리자 - 사용자 목록</title>
</head>

<body class="container py-4">
  <h2 class="mb-4">사용자 목록</h2>

  <div class="mb-3 text-right">
    <button class="btn btn-primary" id="useradd" onclick="showAddUserModal()">+ 사용자 추가</button>
  </div>

  <table id="userTable"
          class="table table-bordered table-hover"
          data-toggle="table"
          data-search="true"
          data-pagination="true"
          data-page-size="5">
    <thead>
      <tr>
        <th data-field="role"     data-sortable="true">권한</th>
        <th data-field="userId"   data-sortable="true"       data-formatter="userIdFormatter">아이디</th>
        <th data-field="username" data-sortable="true">이름</th>
        <th data-field="email"    data-sortable="true">이메일</th>
        <th data-field="isActive" data-sortable="true">사용여부</th>
        <th data-field="actions"  data-events="actionEvents" data-formatter="actionFormatter">관리</th>
      </tr>
    </thead>
  </table>

  <div id="globalModal" style="display:none;">
    <div class="modal-content shadow">
      <div class="modal-header">
        <span class="modal-title"></span>
      </div>
      <div class="modal-body"></div>
      <div class="modal-footer">
        <button id="modalConfirmBtn" class="btn btn-primary">확인</button>
        <button type="button"        class="btn btn-secondary" onclick="Modal.hideModal()">취소</button>
      </div>
    </div>
  </div>
</body>
<script src="/js/common.js"></script>
<script>
  // 테이블 로딩
  async function loadUserTable() {
    const users = await ApiUtil.get("/api/admin/user-list");
    $('#userTable').bootstrapTable('load', users);
  }

  function userIdFormatter(value, row) {
    return `<a href="/admin/user_detail.html?userId=${encodeURIComponent(value)}" class="text-primary">${value}</a>`;
  }

  // 삭제 버튼 렌더링
  function actionFormatter(value, row) {
    return `<button class="btn btn-danger btn-sm delete-btn">삭제</button>`
  }

  // 삭제 버튼 클릭 시
  window.actionEvents = {
    'click .delete-btn': async function (e, value, row) {
      const confirmed = await AlertUtil.showConfirm("정말 삭제하시겠습니까?");
      if(!confirmed) return;

      await ApiUtil.del(`/api/admin/user-delete/${row.userId}`);
      loadUserTable(); // 테이블 새로고침
    }
  }

  // 사용자추가 모달 내용 html
  const formHtml = `
    <form id="addUserForm">
      <div class="form-group mb-3">
        <label for="userId" class="form-label">아이디</label>
        <input
          type        = "text"
          class       = "form-control"
          id          = "userId"
          name        = "userId"
          placeholder = "아이디를 입력하세요"
          required />
      </div>
      <div class="form-group mb-3">
        <label for="username" class="form-label">이름</label>
        <input
          type        = "text"
          class       = "form-control"
          id          = "username"
          name        = "username"
          placeholder = "이름을 입력하세요"
          required />
      </div>
      <div class="form-group mb-3">
        <label for="email" class="form-label">이메일</label>
        <input
          type        = "email"
          class       = "form-control"
          id          = "email"
          name        = "email"
          placeholder = "이메일을 입력하세요"
          required />
      </div>
    </form>
  `;

  // 사용자 추가 버튼 클릭 시
  document.getElementById("useradd").addEventListener("click", function() {
    const modalState = Modal.useGlobalModal();
    if (modalState.visible) {
      Modal.hideModal();
      return;
    }
    Modal.showFormModal({
      title: "사용자 추가",
      formContent: formHtml,
      onConfirm: async () => {
        const form = document.getElementById("addUserForm");
        const data = {
          userId: form.userId.value,
          username: form.username.value,
          email: form.email.value,
        };

        // ApiUtil을 통해 서버로 전송
        const result = await ApiUtil.post("/api/admin/user-add", data);
        
        if(result) {
          // 성공 시 리스트 갱신 등 추가 작업
          location.reload(); // == loadUserTable()
        }
      }
    });
  });

  document.addEventListener("DOMContentLoaded", function() {
    // common.js 호출 이후 실행되도록
    setTimeout(loadUserTable, 100);
  });
</script>